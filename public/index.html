<meta name="HandheldFriendly" content="true" />
<style>
    html,
    body {
        margin: 0;
        width:  100%;
        height: 100%;
        overflow: hidden;
    }
</style>
<html><canvas id="myCanvas" style = "display:block;border:none; margin:0"></canvas></html>

<script type="text/javascript" src ="common.js"></script>
<script type="text/javascript" src ="core/inventory.js"></script>
<script type="text/javascript" src ="core/entity.js"></script>

<script type="text/javascript" src ="core/button.js"></script>
<script type="text/javascript" src ="core/input.js"></script>
<script type="text/javascript" src ="core/render.js"></script>
<script type="text/javascript" src ="core/view.js"></script>
<script type="text/javascript">
    const ws        = new WebSocket('ws://192.168.1.22');
    canvas = document.getElementById("myCanvas");


    let context = canvas.getContext("2d");
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;

    let mousePos    = {x: 0, y: 0}
    var selCity     = undefined;

    let isDragging = false;
    let dragStart = { x: 0, y: 0 }
    let isBuilding = false;
    let workInterval = undefined;
    
    //BUTTONS
    pointerButton = new Button(0,0,tileSize, tileSize);
    for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 5; j++) {
            let newButton = new Button (j * tileSize, i * tileSize, tileSize, tileSize, undefined, invMenu);
            newButton.onClick = () => {pointerButton.item = newButton.item;};
            invMenu.items.push(newButton);
        }
    }

    buildMenu.items.push(new Button (5 * tileSize + 10, 0, tileSize, tileSize, {id: resDB.extractor.id, n: 0}   , invMenu, () => {bookFromInv(player1.inv, [resDB.extractor])}  ))
    buildMenu.items.push(new Button (6 * tileSize + 10, 0, tileSize, tileSize, {id: resDB.furnace.id, n: 0}     , invMenu, () => {bookFromInv(player1.inv, [resDB.furnace])}))
    buildMenu.items.push(new Button (7 * tileSize + 10, 0, tileSize, tileSize, {id: resDB.chest.id, n: 0}       , invMenu, () => {bookFromInv(player1.inv, [resDB.chest])}))
    buildMenu.items.push(new Button (8 * tileSize + 10, 0, tileSize, tileSize, {id: resDB.inserter.id, n: 0}       , invMenu, () => {bookFromInv(player1.inv, [resDB.inserter])}))
    buildMenu.items.push(new Button (9 * tileSize + 10, 0, tileSize, tileSize, {id: resDB.belt.id, n: 0}        , invMenu, () => {bookFromInv(player1.inv, [resDB.belt])}))

    function getCityById(searchID) {
        for (let i = 0; i < city.w.length; i++) {
            let c = city.w[i];
            if (c.id == searchID) return c;
        }
    }



    ws.onmessage = function(e) {
        let socketMsg = JSON.parse(e.data);

        if (socketMsg.msg == "updateInv") {
            allInvs = JSON.parse(JSON.stringify(socketMsg.data));
        }
        if (socketMsg.msg == "updateEntities") {
            allEnts = JSON.parse(JSON.stringify(socketMsg.data));
        }
        if (socketMsg.msg == "updatePlayer") {
            player1 = socketMsg.data;
            player1.invOb = new Inventory(undefined, {x: 0, y:0});
            player1.invOb.packsize = 10;
            player1.invOb.addItems(player1.inv.packs);
            player1.inv = player1.invOb;
            delete player1.invOb;

            for (let i = 0; i < player1.inv.packs.length; i++) {
                let item = player1.inv.packs[i];
                invMenu.items[i].item = item;
            }

            for (let i = player1.inv.packs.length; i < invMenu.items.length; i++) {
                invMenu.items[i].item = undefined
            }
        }
        if (socketMsg.msg == "updateMap") { game = socketMsg.data; }
        if (socketMsg.msg == "updateMapData") { game.map = socketMsg.data; }

        if (socketMsg.msg == "id") console.log("Received: '" + socketMsg.data + "'");
    };

    function onKeyDown(e){
        ws.send(JSON.stringify({cmd: "keydown", data: e.code}));
    }

    function onKeyUp(e){
        if(e.code == "KeyR") buildDir = (buildDir+1)%4
        ws.send(JSON.stringify({cmd: "keyup", data: e.code}));
    }

    document.addEventListener("keydown", onKeyDown);
    document.addEventListener("keyup", onKeyUp);
    document.addEventListener("wheel", (e) => adjustZoom(e.deltaY* SCROLL_SENSITIVITY))
    context.canvas.oncontextmenu = function (e) {e.preventDefault();};
    let inp = new InputModule (context.canvas);
    let view = new ViewModule (window);

    requestAnimationFrame( render );
    

    function adjustZoom(zoomFactor)
    {
        if (!isDragging)
        {
            //console.log(zoomFactor)
            zoomFactor *= -1;

            let zoomAmount = (1 + zoomFactor);
            camera.zoom *= zoomAmount;
           
            //camera.zoom = Math.min( camera.zoom, MAX_ZOOM )
            //camera.zoom = Math.max( camera.zoom, MIN_ZOOM )

            camera.x += (mousePos.x / camera.zoom) - (mousePos.x / (camera.zoom / zoomAmount));
            camera.y += (mousePos.y / camera.zoom) - (mousePos.y / (camera.zoom / zoomAmount));
            if (camera.x > 0) camera.x = 0;
            if (camera.y > 0) camera.y = 0;
            ws.send(JSON.stringify({cmd: "camera", data: camera}));
        }
    }

    // Gets the relevant location from a mouse or single touch event
    function getEventLocation(e) {
        if (e.touches && e.touches.length == 1)
        {
            return { x:e.touches[0].clientX, y: e.touches[0].clientY }
        }
        else if (e.clientX && e.clientY)
        {
            return { x: e.clientX, y: e.clientY }
        }
    }

    function mineToInv(inv) {
        ws.send(JSON.stringify({cmd: "mineToInv", data: inv}));
    }


    Object.keys(resDB).forEach(key => {
            const image = new Image(tileSize, tileSize);
            if (resDB[key].type == "machine") image.src =  "machine/" + key + "/" + key +".png";
            else image.src =  "res/" + key +".png";
            resDB[key].img = image;
        }
    )

    let buildImage = new Image(tileSize, tileSize);
    buildImage.src = "core/build.png";
    let craftButton = new Button (tileSize*10 + 10, 0, tileSize, tileSize, undefined, beltMenu, () => {invMenu.vis = !invMenu.vis;buildMenu.vis = !buildMenu.vis; pointerButton.item = undefined;}, buildImage);
    beltMenu.vis = true;
    beltMenu.items.push(craftButton);

</script>