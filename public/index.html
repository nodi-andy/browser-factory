<meta name="HandheldFriendly" content="true" />
<style>
    html,
    body {
        margin: 0;
        width:  100%;
        height: 100%;
        overflow: hidden;
    }
</style>
<html><canvas id="myCanvas" style = "display:block;border:none; margin:0"></canvas></html>

<script type="text/javascript" src ="common.js"></script>
<script type="text/javascript" src ="core/inventory.js"></script>
<script type="text/javascript" src ="core/entity.js"></script>
<script type="text/javascript" src ="core/socket.js"></script>

<script type="text/javascript" src ="core/button.js"></script>
<script type="text/javascript" src ="core/input.js"></script>
<script type="text/javascript" src ="core/render.js"></script>
<script type="text/javascript" src ="core/view.js"></script>
<script type="text/javascript" src ="entity/player/player.js"></script>
<script type="text/javascript">

    canvas = document.getElementById("myCanvas");
    let context = canvas.getContext("2d");
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;

    let mousePos    = {x: 0, y: 0}
    var selCity     = undefined;

    let isDragging = false;
    let dragStart = { x: 0, y: 0 }
    let isBuilding = false;
    let workInterval = undefined;
    
    c.player1 = new Player();
    c.player1.inv = new Inventory();
    player1 = c.player1;
    
    //BUTTONS
    pointerButton = new Button(0,0);

    // INV MENU
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            let newButton = new Button (j * tileSize, i * tileSize, undefined, invMenu);
            newButton.onClick = () => {pointerButton.item = newButton.item;};
            invMenu.items.push(newButton);
        }
    }

    // CRAFT MENU
    craftMenu.items.push(new Button (0 * buttonSize, 0, {id: resDB.wood.id, n: 0}   , craftMenu, () => {bookFromInv(c.player1.inv, [resDB.wood])}  ))
    craftMenu.items.push(new Button (1 * buttonSize, 0, {id: resDB.stone_furnace.id, n: 0}     , craftMenu, () => {bookFromInv(c.player1.inv, [resDB.furnace])}))
    craftMenu.items.push(new Button (2 * buttonSize, 0, {id: resDB.chest.id, n: 0}       , craftMenu, () => {bookFromInv(c.player1.inv, [resDB.chest])}))
    craftMenu.items.push(new Button (3 * buttonSize, 0, {id: resDB.inserter.id, n: 0}    , craftMenu, () => {bookFromInv(c.player1.inv, [resDB.inserter])}))
    craftMenu.items.push(new Button (4 * buttonSize, 0, {id: resDB.belt.id, n: 0}        , craftMenu, () => {bookFromInv(c.player1.inv, [resDB.belt])}))

    function getCityById(searchID) {
        for (let i = 0; i < city.w.length; i++) {
            let c = city.w[i];
            if (c.id == searchID) return c;
        }
    }

    
    function onKeyDown(e){
        //ws.send(JSON.stringify({cmd: "keydown", data: e.code}));
        if(e.code == "KeyW") c.player1.dir.y = -1;
        if(e.code == "KeyS") c.player1.dir.y =1;
        if(e.code == "KeyD") c.player1.dir.x = 1;
        if(e.code == "KeyA") c.player1.dir.x = -1;
    }

    function onKeyUp(e){
        if(e.code == "KeyW") c.player1.dir.y = 0;
        if(e.code == "KeyS") c.player1.dir.y = 0;
        if(e.code == "KeyD") c.player1.dir.x = 0;
        if(e.code == "KeyA") c.player1.dir.x = 0;
        if(e.code == "KeyR") buildDir = (buildDir+1)%4;
        if(e.code == "KeyE") { invMenu.vis = !invMenu.vis; craftMenu.vis = !craftMenu.vis}
        ws.send(JSON.stringify({cmd: "keyup", data: e.code}));
    }

    document.addEventListener("keydown", onKeyDown);
    document.addEventListener("keyup", onKeyUp);

    context.canvas.oncontextmenu = function (e) {e.preventDefault();};
    let inp = new InputModule (context.canvas);
    let view = new ViewModule (window);


    // LOAD IMAGES
    Object.keys(resDB).forEach(key => {
            const image = new Image(tileSize, tileSize);
            image.src =  resDB[key].type + "/" + key + "/" + key + ".png";
            resDB[key].img = image;
        }
    )

    let buildImage = new Image(tileSize, tileSize);
    buildImage.src = "core/build.png";
    let craftButton = new Button (tileSize*5 + 10, 0, undefined, beltMenu, () => {invMenu.vis = !invMenu.vis;craftMenu.vis = !craftMenu.vis; pointerButton.item = undefined;}, buildImage);
    beltMenu.vis = true;
    beltMenu.items.push(craftButton);

    canvas.offScreenCanvas = document.createElement('canvas');



    requestAnimationFrame( render );

    gameLoop();
    function gameLoop(){
        /*Object.keys(resDB).forEach(key => {
            if(resDB[key].mach && resDB[key].mach.loop) resDB[key].mach.loop();
        }
        )*/
        c.player1.loop();
        setTimeout(gameLoop, 1000/60);
    }

</script>